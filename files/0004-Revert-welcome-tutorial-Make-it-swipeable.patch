From e09502095a49b75ab9e45eb4115a4f4977d79497 Mon Sep 17 00:00:00 2001
From: Joshua Strobl <joshua@streambits.io>
Date: Sat, 17 Apr 2021 04:30:43 +0300
Subject: [PATCH 4/5] Revert "welcome-tutorial: Make it swipeable"

This reverts commit df5364c62e4d48bafacca703803401a763306be7.
---
 data/gtk-style.css               |  4 +-
 data/ui/welcome-tutorial-page.ui |  1 -
 data/ui/welcome-tutorial.ui      | 13 +++---
 src/welcome-tutorial-page.vala   |  3 +-
 src/welcome-tutorial.vala        | 73 +++++++++++---------------------
 5 files changed, 32 insertions(+), 62 deletions(-)

diff --git a/data/gtk-style.css b/data/gtk-style.css
index e3d0cc85..ae24b066 100644
--- a/data/gtk-style.css
+++ b/data/gtk-style.css
@@ -134,8 +134,6 @@ separator {
     background-position: center 15%;
 }
 
-.welcome-tutorial,
-.welcome-tutorial-title-label,
-.welcome-tutorial-description-label {
+.welcome-tutorial-title-label, .welcome-tutorial-description-label {
     color: white;
 }
diff --git a/data/ui/welcome-tutorial-page.ui b/data/ui/welcome-tutorial-page.ui
index 2f8b22f6..ec2fdcae 100644
--- a/data/ui/welcome-tutorial-page.ui
+++ b/data/ui/welcome-tutorial-page.ui
@@ -4,7 +4,6 @@
     <property name="visible">True</property>
     <property name="orientation">vertical</property>
     <property name="spacing">10</property>
-    <property name="expand">True</property>
     <signal name="map" handler="load_css"/>
     <style>
       <class name="tutorial-page"/>
diff --git a/data/ui/welcome-tutorial.ui b/data/ui/welcome-tutorial.ui
index ce7b791f..ab3d49eb 100644
--- a/data/ui/welcome-tutorial.ui
+++ b/data/ui/welcome-tutorial.ui
@@ -8,9 +8,6 @@
     <property name="height-request">600</property>
     <property name="width-request">710</property>
     <signal name="delete-event" handler="gtk_widget_hide_on_delete"/>
-    <style>
-      <class name="welcome-tutorial"/>
-    </style>
 
     <child internal-child="vbox">
       <object class="GtkBox">
@@ -23,11 +20,11 @@
             <property name="expand">True</property>
 
             <child>
-              <object class="HdyCarousel" id="paginator">
+              <object class="GtkStack" id="stack">
                 <property name="visible">True</property>
-                <property name="animation-duration">400</property>
-                <property name="margin-bottom">12</property>
-                <signal name="notify::position" handler="on_position_changed"/>
+                <property name="transition-duration">400</property>
+                <property name="transition-type">slide-left-right</property>
+                <signal name="notify::visible-child" handler="on_stack_page_changed"/>
 
                 <child>
                   <object class="BoxesWelcomeTutorialPage">
@@ -75,7 +72,7 @@
 
                 <child>
                   <object class="GtkButton" id="go_back_button">
-                    <property name="visible">True</property>
+                    <property name="visible">False</property>
                     <property name="can-focus">True</property>
                     <property name="valign">center</property>
                     <signal name="clicked" handler="on_back_button_clicked"/>
diff --git a/src/welcome-tutorial-page.vala b/src/welcome-tutorial-page.vala
index 0df7b5f1..bb03a51d 100644
--- a/src/welcome-tutorial-page.vala
+++ b/src/welcome-tutorial-page.vala
@@ -33,9 +33,10 @@ private void load_css () {
         var provider = new CssProvider ();
         var css = """
           .tutorial-page {
+            background-color: %s;
             background-image: url("resource://%s");
           }
-        """.printf (image);
+        """.printf (color.to_string (), image);
 
         try {
             provider.load_from_data (css);
diff --git a/src/welcome-tutorial.vala b/src/welcome-tutorial.vala
index be920cae..3d97b9c5 100644
--- a/src/welcome-tutorial.vala
+++ b/src/welcome-tutorial.vala
@@ -1,87 +1,62 @@
 // This file is part of GNOME Boxes. License: LGPLv2+
 using Gtk;
-using Hdy;
 
 [GtkTemplate (ui = "/org/gnome/Boxes/ui/welcome-tutorial.ui")]
 private class Boxes.WelcomeTutorial : Gtk.Dialog {
     [GtkChild]
-    private unowned Carousel paginator;
+    private Stack stack;
     [GtkChild]
     private unowned Button go_back_button;
     [GtkChild]
     private unowned Button go_next_button;
 
-    private GLib.List<unowned WelcomeTutorialPage> pages;
-    private CssProvider provider;
+    private GLib.List<unowned Widget> pages;
 
-    construct {
-        use_header_bar = 1;
+    private uint _visible_page_idx = 0;
+    private uint visible_page_idx {
+        set {
+            _visible_page_idx = value;
 
-        pages = new GLib.List<unowned WelcomeTutorialPage> ();
-        foreach (var page in paginator.get_children ()) {
-            assert (page is WelcomeTutorialPage);
-            pages.append (page as WelcomeTutorialPage);
+            stack.set_visible_child (pages.nth_data (visible_page_idx));
         }
+        get {
+            return _visible_page_idx;
+        }
+    }
+
+    construct {
+        use_header_bar = 1;
 
-        provider = new CssProvider ();
-        get_style_context ().add_provider (provider,
-                                           STYLE_PROVIDER_PRIORITY_APPLICATION);
+        pages = stack.get_children ();
 
-        on_position_changed ();
+        on_stack_page_changed ();
     }
 
     public WelcomeTutorial (AppWindow app_window) {
         set_transient_for (app_window);
     }
 
-    private void set_background_color (Gdk.RGBA color) {
-        var css = """
-          .welcome-tutorial {
-            background-color: %s;
-          }
-        """.printf (color.to_string ());
-
-        provider.load_from_data (css);
-    }
-
     [GtkCallback]
-    private void on_position_changed () {
+    private void on_stack_page_changed () {
         var n_pages = pages.length ();
-        var position = paginator.position;
 
-        // Toggle button's visibility
-        go_back_button.opacity = double.min (position, 1);
-        go_next_button.opacity = double.max (0, n_pages - 1 - position);
+        var topbar = get_header_bar () as Gtk.HeaderBar;
+        topbar.subtitle = _("%u/%u").printf (visible_page_idx + 1, n_pages);
 
-        var color1 = pages.nth_data ((uint) Math.floor (position)).color;
-        var color2 = pages.nth_data ((uint) Math.ceil (position)).color;
-        var progress = position % 1;
+        // Toggle button's visibility
+        go_back_button.visible = (visible_page_idx > 0);
+        go_next_button.visible = (visible_page_idx < pages.length () - 1);
 
-        Gdk.RGBA rgba = {
-            red:   color1.red   * (1 - progress) + color2.red   * progress,
-            green: color1.green * (1 - progress) + color2.green * progress,
-            blue:  color1.blue  * (1 - progress) + color2.blue  * progress,
-            alpha: 1
-        };
-        set_background_color (rgba);
     }
 
     [GtkCallback]
     private void on_next_button_clicked () {
-        var index = (int) Math.round (paginator.position) + 1;
-        if (index >= pages.length ())
-            return;
-
-        paginator.scroll_to (pages.nth_data (index));
+        visible_page_idx += 1;
 
     }
 
     [GtkCallback]
     private void on_back_button_clicked () {
-        var index = (int) Math.round (paginator.position) - 1;
-        if (index < 0)
-            return;
-
-        paginator.scroll_to (pages.nth_data (index));
+        visible_page_idx -= 1;
     }
 }
-- 
2.32.0

